(function(){(function(){var $,cardFromNumber,cardFromType,cards,defaultFormat,formatBackCardNumber,formatBackExpiry,formatCardNumber,formatExpiry,formatForwardExpiry,formatForwardSlashAndSpace,hasTextSelected,luhnCheck,reFormatCVC,reFormatCardNumber,reFormatExpiry,reFormatNumeric,replaceFullWidthChars,restrictCVC,restrictCardNumber,restrictExpiry,restrictNumeric,safeVal,setCardType,__slice=[].slice,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1};$=window.jQuery||window.Zepto||window.$,$.payment={},$.payment.fn={},$.fn.payment=function(){var args,method;return method=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[],$.payment.fn[method].apply(this,args)},defaultFormat=/(\d{1,4})/g,$.payment.cards=cards=[{type:"elo",patterns:[401178,401179,431274,438935,451416,457393,457631,457632,504175,506699,5067,509,627780,636297,636368,650,6516,6550],format:defaultFormat,length:[16],cvcLength:[3],luhn:!0},{type:"visaelectron",patterns:[4026,417500,4405,4508,4844,4913,4917],format:defaultFormat,length:[16],cvcLength:[3],luhn:!0},{type:"maestro",patterns:[5018,502,503,506,56,58,639,6220,67],format:defaultFormat,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"forbrugsforeningen",patterns:[600],format:defaultFormat,length:[16],cvcLength:[3],luhn:!0},{type:"dankort",patterns:[5019],format:defaultFormat,length:[16],cvcLength:[3],luhn:!0},{type:"visa",patterns:[4],format:defaultFormat,length:[13,16],cvcLength:[3],luhn:!0},{type:"mastercard",patterns:[51,52,53,54,55,22,23,24,25,26,27],format:defaultFormat,length:[16],cvcLength:[3],luhn:!0},{type:"amex",patterns:[34,37],format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,length:[15],cvcLength:[3,4],luhn:!0},{type:"dinersclub",patterns:[30,36,38,39],format:/(\d{1,4})(\d{1,6})?(\d{1,4})?/,length:[14],cvcLength:[3],luhn:!0},{type:"discover",patterns:[60,64,65,622],format:defaultFormat,length:[16],cvcLength:[3],luhn:!0},{type:"unionpay",patterns:[62,88],format:defaultFormat,length:[16,17,18,19],cvcLength:[3],luhn:!1},{type:"jcb",patterns:[35],format:defaultFormat,length:[16],cvcLength:[3],luhn:!0}],cardFromNumber=function(num){var card,p,pattern,_i,_j,_len,_len1,_ref;for(num=(num+"").replace(/\D/g,""),_i=0,_len=cards.length;_i<_len;_i++)for(card=cards[_i],_ref=card.patterns,_j=0,_len1=_ref.length;_j<_len1;_j++)if(pattern=_ref[_j],p=pattern+"",num.substr(0,p.length)===p)return card},cardFromType=function(type){var card,_i,_len;for(_i=0,_len=cards.length;_i<_len;_i++)if(card=cards[_i],card.type===type)return card},luhnCheck=function(num){var digit,digits,odd,sum,_i,_len;for(odd=!0,sum=0,digits=(num+"").split("").reverse(),_i=0,_len=digits.length;_i<_len;_i++)digit=digits[_i],digit=parseInt(digit,10),(odd=!odd)&&(digit*=2),digit>9&&(digit-=9),sum+=digit;return sum%10==0},hasTextSelected=function($target){var _ref;return null!=$target.prop("selectionStart")&&$target.prop("selectionStart")!==$target.prop("selectionEnd")||!(null==("undefined"!=typeof document&&null!==document&&null!=(_ref=document.selection)?_ref.createRange:void 0)||!document.selection.createRange().text)},safeVal=function(value,$target){var currPair,cursor,digit,last,prevPair;try{cursor=$target.prop("selectionStart")}catch(_error){_error,cursor=null}if(last=$target.val(),$target.val(value),null!==cursor&&$target.is(":focus"))return cursor===last.length&&(cursor=value.length),last!==value&&(prevPair=last.slice(cursor-1,+cursor+1||9e9),currPair=value.slice(cursor-1,+cursor+1||9e9),digit=value[cursor],/\d/.test(digit)&&prevPair===digit+" "&&currPair===" "+digit&&(cursor+=1)),$target.prop("selectionStart",cursor),$target.prop("selectionEnd",cursor)},replaceFullWidthChars=function(str){var chars,chr,fullWidth,halfWidth,idx,value,_i,_len;for(null==str&&(str=""),fullWidth="０１２３４５６７８９",halfWidth="0123456789",value="",chars=str.split(""),_i=0,_len=chars.length;_i<_len;_i++)chr=chars[_i],idx=fullWidth.indexOf(chr),idx>-1&&(chr=halfWidth[idx]),value+=chr;return value},reFormatNumeric=function(e){var $target;return $target=$(e.currentTarget),setTimeout(function(){var value;return value=$target.val(),value=replaceFullWidthChars(value),value=value.replace(/\D/g,""),safeVal(value,$target)})},reFormatCardNumber=function(e){var $target;return $target=$(e.currentTarget),setTimeout(function(){var value;return value=$target.val(),value=replaceFullWidthChars(value),value=$.payment.formatCardNumber(value),safeVal(value,$target)})},formatCardNumber=function(e){var $target,card,digit,length,re,upperLength,value;if(digit=String.fromCharCode(e.which),/^\d+$/.test(digit)&&($target=$(e.currentTarget),value=$target.val(),card=cardFromNumber(value+digit),length=(value.replace(/\D/g,"")+digit).length,upperLength=16,card&&(upperLength=card.length[card.length.length-1]),!(length>=upperLength||null!=$target.prop("selectionStart")&&$target.prop("selectionStart")!==value.length)))return re=card&&"amex"===card.type?/^(\d{4}|\d{4}\s\d{6})$/:/(?:^|\s)(\d{4})$/,re.test(value)?(e.preventDefault(),setTimeout(function(){return $target.val(value+" "+digit)})):re.test(value+digit)?(e.preventDefault(),setTimeout(function(){return $target.val(value+digit+" ")})):void 0},formatBackCardNumber=function(e){var $target,value;if($target=$(e.currentTarget),value=$target.val(),8===e.which&&(null==$target.prop("selectionStart")||$target.prop("selectionStart")===value.length))return/\d\s$/.test(value)?(e.preventDefault(),setTimeout(function(){return $target.val(value.replace(/\d\s$/,""))})):/\s\d?$/.test(value)?(e.preventDefault(),setTimeout(function(){return $target.val(value.replace(/\d$/,""))})):void 0},reFormatExpiry=function(e){var $target;return $target=$(e.currentTarget),setTimeout(function(){var value;return value=$target.val(),value=replaceFullWidthChars(value),value=$.payment.formatExpiry(value),safeVal(value,$target)})},formatExpiry=function(e){var $target,digit,val;if(digit=String.fromCharCode(e.which),/^\d+$/.test(digit))return $target=$(e.currentTarget),val=$target.val()+digit,/^\d$/.test(val)&&"0"!==val&&"1"!==val?(e.preventDefault(),setTimeout(function(){return $target.val("0"+val+" / ")})):/^\d\d$/.test(val)?(e.preventDefault(),setTimeout(function(){var m1,m2;return m1=parseInt(val[0],10),m2=parseInt(val[1],10),m2>2&&0!==m1?$target.val("0"+m1+" / "+m2):$target.val(val+" / ")})):void 0},formatForwardExpiry=function(e){var $target,digit,val;if(digit=String.fromCharCode(e.which),/^\d+$/.test(digit))return $target=$(e.currentTarget),val=$target.val(),/^\d\d$/.test(val)?$target.val(val+" / "):void 0},formatForwardSlashAndSpace=function(e){var $target,val,which;if("/"===(which=String.fromCharCode(e.which))||" "===which)return $target=$(e.currentTarget),val=$target.val(),/^\d$/.test(val)&&"0"!==val?$target.val("0"+val+" / "):void 0},formatBackExpiry=function(e){var $target,value;if($target=$(e.currentTarget),value=$target.val(),8===e.which&&(null==$target.prop("selectionStart")||$target.prop("selectionStart")===value.length))return/\d\s\/\s$/.test(value)?(e.preventDefault(),setTimeout(function(){return $target.val(value.replace(/\d\s\/\s$/,""))})):void 0},reFormatCVC=function(e){var $target;return $target=$(e.currentTarget),setTimeout(function(){var value;return value=$target.val(),value=replaceFullWidthChars(value),value=value.replace(/\D/g,"").slice(0,4),safeVal(value,$target)})},restrictNumeric=function(e){var input;return!(!e.metaKey&&!e.ctrlKey)||32!==e.which&&(0===e.which||(e.which<33||(input=String.fromCharCode(e.which),!!/[\d\s]/.test(input))))},restrictCardNumber=function(e){var $target,card,digit,value;if($target=$(e.currentTarget),digit=String.fromCharCode(e.which),/^\d+$/.test(digit)&&!hasTextSelected($target))return value=($target.val()+digit).replace(/\D/g,""),card=cardFromNumber(value),card?value.length<=card.length[card.length.length-1]:value.length<=16},restrictExpiry=function(e){var $target,digit,value;if($target=$(e.currentTarget),digit=String.fromCharCode(e.which),/^\d+$/.test(digit)&&!hasTextSelected($target))return value=$target.val()+digit,value=value.replace(/\D/g,""),!(value.length>6)&&void 0},restrictCVC=function(e){var $target,digit,val;if($target=$(e.currentTarget),digit=String.fromCharCode(e.which),/^\d+$/.test(digit)&&!hasTextSelected($target))return val=$target.val()+digit,val.length<=4},setCardType=function(e){var $target,allTypes,card,cardType,val;if($target=$(e.currentTarget),val=$target.val(),cardType=$.payment.cardType(val)||"unknown",!$target.hasClass(cardType))return allTypes=function(){var _i,_len,_results;for(_results=[],_i=0,_len=cards.length;_i<_len;_i++)card=cards[_i],_results.push(card.type);return _results}(),$target.removeClass("unknown"),$target.removeClass(allTypes.join(" ")),$target.addClass(cardType),$target.toggleClass("identified","unknown"!==cardType),$target.trigger("payment.cardType",cardType)},$.payment.fn.formatCardCVC=function(){return this.on("keypress",restrictNumeric),this.on("keypress",restrictCVC),this.on("paste",reFormatCVC),this.on("change",reFormatCVC),this.on("input",reFormatCVC),this},$.payment.fn.formatCardExpiry=function(){return this.on("keypress",restrictNumeric),this.on("keypress",restrictExpiry),this.on("keypress",formatExpiry),this.on("keypress",formatForwardSlashAndSpace),this.on("keypress",formatForwardExpiry),this.on("keydown",formatBackExpiry),this.on("change",reFormatExpiry),this.on("input",reFormatExpiry),this},$.payment.fn.formatCardNumber=function(){return this.on("keypress",restrictNumeric),this.on("keypress",restrictCardNumber),this.on("keypress",formatCardNumber),this.on("keydown",formatBackCardNumber),this.on("keyup",setCardType),this.on("paste",reFormatCardNumber),this.on("change",reFormatCardNumber),this.on("input",reFormatCardNumber),this.on("input",setCardType),this},$.payment.fn.restrictNumeric=function(){return this.on("keypress",restrictNumeric),this.on("paste",reFormatNumeric),this.on("change",reFormatNumeric),this.on("input",reFormatNumeric),this},$.payment.fn.cardExpiryVal=function(){return $.payment.cardExpiryVal($(this).val())},$.payment.cardExpiryVal=function(value){var month,prefix,year,_ref;return _ref=value.split(/[\s\/]+/,2),month=_ref[0],year=_ref[1],2===(null!=year?year.length:void 0)&&/^\d+$/.test(year)&&(prefix=(new Date).getFullYear(),prefix=prefix.toString().slice(0,2),year=prefix+year),month=parseInt(month,10),year=parseInt(year,10),{month:month,year:year}},$.payment.validateCardNumber=function(num){var card,_ref;return num=(num+"").replace(/\s+|-/g,""),!!/^\d+$/.test(num)&&(!!(card=cardFromNumber(num))&&(_ref=num.length,__indexOf.call(card.length,_ref)>=0&&(!1===card.luhn||luhnCheck(num))))},$.payment.validateCardExpiry=function(month,year){var currentTime,expiry,_ref;return"object"==typeof month&&"month"in month&&(_ref=month,month=_ref.month,year=_ref.year),!(!month||!year)&&(month=$.trim(month),year=$.trim(year),!!/^\d+$/.test(month)&&(!!/^\d+$/.test(year)&&(1<=month&&month<=12&&(2===year.length&&(year=year<70?"20"+year:"19"+year),4===year.length&&(expiry=new Date(year,month),currentTime=new Date,expiry.setMonth(expiry.getMonth()-1),expiry.setMonth(expiry.getMonth()+1,1),expiry>currentTime)))))},$.payment.validateCardCVC=function(cvc,type){var card,_ref;return cvc=$.trim(cvc),!!/^\d+$/.test(cvc)&&(card=cardFromType(type),null!=card?(_ref=cvc.length,__indexOf.call(card.cvcLength,_ref)>=0):cvc.length>=3&&cvc.length<=4)},$.payment.cardType=function(num){var _ref;return num?(null!=(_ref=cardFromNumber(num))?_ref.type:void 0)||null:null},$.payment.formatCardNumber=function(num){var card,groups,upperLength,_ref;return num=num.replace(/\D/g,""),(card=cardFromNumber(num))?(upperLength=card.length[card.length.length-1],num=num.slice(0,upperLength),card.format.global?null!=(_ref=num.match(card.format))?_ref.join(" "):void 0:null!=(groups=card.format.exec(num))?(groups.shift(),groups=$.grep(groups,function(n){return n}),groups.join(" ")):void 0):num},$.payment.formatExpiry=function(expiry){var mon,parts,sep,year;return(parts=expiry.match(/^\D*(\d{1,2})(\D+)?(\d{1,4})?/))?(mon=parts[1]||"",sep=parts[2]||"",year=parts[3]||"",year.length>0?sep=" / ":" /"===sep?(mon=mon.substring(0,1),sep=""):2===mon.length||sep.length>0?sep=" / ":1===mon.length&&"0"!==mon&&"1"!==mon&&(mon="0"+mon,sep=" / "),mon+sep+year):""}}).call(this)}).call(this);
